cat > ~/.pk_aliases << 'EOF'
# ===== PiKaraoke updater / helper =====

# Core repo config
export PK_HOME="${PK_HOME:-$HOME/deskpi-karaoke}"
export PK_REMOTE="${PK_REMOTE:-https://github.com/junclemente/deskpi-karaoke.git}"   # change if you use a fork

# State dir and flags
export PK_STATE="${PK_STATE:-$HOME/.deskpi-karaoke}"
export PK_REBOOT_FLAG="$PK_STATE/.reboot_required"
mkdir -p "$PK_STATE"

# Files to remember what we've applied
export PK_LAST_SHA_MAIN="$PK_STATE/.last_applied_sha_main"
export PK_LAST_SHA_DEV="$PK_STATE/.last_applied_sha_dev"
export PK_VER_FILE="$PK_STATE/VERSION"   # written by installer on main only

_pk_sync_repo_branch() {
  local branch="$1"
  if [ ! -d "$PK_HOME/.git" ]; then
    echo "â„¹ï¸ $PK_HOME is not a git repo. Cloning fresh..."
    rm -rf "$PK_HOME" && git clone "$PK_REMOTE" "$PK_HOME" || { echo "âŒ Clone failed"; return 2; }
  fi

  git -C "$PK_HOME" fetch --prune --tags || { echo "âŒ git fetch failed"; return 2; }
  git -C "$PK_HOME" checkout "$branch" >/dev/null 2>&1 || \
    git -C "$PK_HOME" checkout -t "origin/$branch" || { echo "âŒ Could not checkout $branch"; return 2; }

  local remote_sha local_sha
  remote_sha="$(git -C "$PK_HOME" rev-parse "origin/$branch" || echo "")"
  [ -z "$remote_sha" ] && { echo "âŒ Could not resolve origin/$branch"; return 2; }

  # Fast-forward if behind
  local_sha="$(git -C "$PK_HOME" rev-parse HEAD || echo "")"
  if [ "$local_sha" != "$remote_sha" ]; then
    git -C "$PK_HOME" merge --ff-only "$remote_sha" || { echo "âŒ FF merge failed"; return 2; }
    echo "â¬†ï¸  Updated $branch â†’ $(git -C "$PK_HOME" rev-parse HEAD)"
    return 1   # changed
  fi

  echo "âœ… Repo already at $branch @ $remote_sha"
  return 0     # no change
}

_pk_run_installer_then_maybe_reboot() {
  echo "â–¶ï¸ Running installerâ€¦"
  python3 "$PK_HOME/install.py" || { echo "âŒ Installer update failed"; return 3; }
  if [ -f "$PK_REBOOT_FLAG" ]; then
    echo "â™»ï¸ Reboot requested by installer. Rebootingâ€¦"
    rm -f "$PK_REBOOT_FLAG"
    sudo reboot
  else
    echo "âœ… Installer completed. No reboot requested."
  fi
}

pk() {
  case "$1" in
    update)
      echo "ğŸ“¥ Updating *main*â€¦"
      _pk_sync_repo_branch "main"; rc=$?
      [ $rc -eq 2 ] && return 1

      # main: version gate â€” skip if VERSION unchanged
      latest_tag="$(git -C "$PK_HOME" tag --sort=-v:refname | head -n1 | sed 's/^v//;s/^V//')"
      recorded_ver="$( [ -f "$PK_VER_FILE" ] && cat "$PK_VER_FILE" || echo "" )"

      if [ $rc -eq 0 ] && [ -n "$latest_tag" ] && [ "$recorded_ver" = "$latest_tag" ]; then
        echo "âœ… Already on main v$recorded_ver. Nothing to do."
        return 0
      fi

      _pk_run_installer_then_maybe_reboot || return $?
      [ -n "$latest_tag" ] && echo "$latest_tag" > "$PK_VER_FILE"
      ;;

    dev|devupdate)
      echo "ğŸ›  Updating *dev*â€¦"
      _pk_sync_repo_branch "dev"; rc=$?
      [ $rc -eq 2 ] && return 1

      current_dev_sha="$(git -C "$PK_HOME" rev-parse origin/dev)"
      last_applied_sha="$( [ -f "$PK_LAST_SHA_DEV" ] && cat "$PK_LAST_SHA_DEV" || echo "" )"

      if [ $rc -eq 0 ] && [ "$current_dev_sha" = "$last_applied_sha" ] && [ -n "$current_dev_sha" ]; then
        echo "âœ… Dev up to date (applied @ $current_dev_sha). Skipping."
        return 0
      fi

      _pk_run_installer_then_maybe_reboot || return $?
      echo "$current_dev_sha" > "$PK_LAST_SHA_DEV"
      ;;

    version)
      [ -f "$PK_VER_FILE" ] && echo "ğŸ“„ Installed (recorded main): v$(cat "$PK_VER_FILE")" || echo "ğŸ“„ Installed (recorded main): unknown"
      echo "ğŸ·ï¸ Latest tag: $(git -C "$PK_HOME" fetch --tags >/dev/null 2>&1; git -C "$PK_HOME" tag --sort=-v:refname | head -n1)"
      echo "ğŸ”§ Last applied dev SHA: $( [ -f "$PK_LAST_SHA_DEV" ] && cat "$PK_LAST_SHA_DEV" || echo 'unknown')"
      ;;

    reboot) echo "â™»ï¸ Rebooting Raspberry Piâ€¦"; sudo reboot ;;
    help|*|"")
      echo ""
      echo "ğŸ“Œ PiKaraoke Commands:"
      echo "   pk update      â†’ Update from main; run only if new version/tag or repo changed"
      echo "   pk devupdate   â†’ Update from dev; run only if origin/dev moved (SHA changed)"
      echo "   pk version     â†’ Show recorded main version, latest tag, and last applied dev SHA"
      echo "   pk reboot      â†’ Reboot the Raspberry Pi"
      echo "   pk help        â†’ Show this help message"
      echo ""
      ;;
  esac
}

# Tiny helpers so you can quickly edit this file
pk_aliases() { nano "$HOME/.pk_aliases"; }
pi_aliases() { pk_aliases; }
EOF
